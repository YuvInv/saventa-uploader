# Dealigence Integration - Technical Specification

## 1. OVERVIEW

### 1.1 Project Goal
Extend the existing saventa-uploader Chrome extension to support direct data extraction from Dealigence company pages, enabling one-click upload of company information to the Saventa CRM.

### 1.2 Current Architecture Understanding
- Extension uses Manifest V3
- React + TypeScript frontend (popup/sidepanel)
- Background service worker for API communication
- Supports CSV bulk upload with field mapping
- Uses browser's existing Sevanta login session (no API key needed)
- Field schema fetched dynamically from CRM API

### 1.3 Integration Approach
- Add new **content script** to detect and extract data from Dealigence pages
- Add new UI mode in popup/sidepanel for "Quick Upload" from current page
- Reuse existing validation, duplicate checking, and upload logic
- Minimal changes to background service worker

---

## 2. DEALIGENCE PAGE STRUCTURE ANALYSIS

### 2.1 URL Pattern
```
https://dealigence.vc/company/{company-slug}
```
**Examples:**
- https://dealigence.vc/company/eyecuracy
- https://dealigence.vc/company/craniosense
- https://dealigence.vc/company/brainspace-7zre8

**Detection Pattern:**
```typescript
const isDealigencePage = /^https:\\/\\/dealigence\\.vc\\/company\\/[^\\/]+$/.test(window.location.href);
```

### 2.2 DOM Structure

Dealigence uses a React-based SPA with the following structure:
```html

  CompanyName
  Description text...
  
  
  
    B2B
    Healthcare
    SaaS
  
  
  
  
    Employees
    7
  
  
    Funding Status
    Fundraising
  
  
    Established
    March 2022
  
  
    Total Funding
    $1m
  
  
    ARR
    $500k
  
  
  
  
    Insights
    
      Fundraising
      Q2/25
      Likely fundraising after extended funding silence.
    
  
  
  
  
    Founders
    
  
  
  
  
    Stakeholders & Advisors
    
  

```

### 2.3 Key Data Extraction Points

| Data Point | DOM Selector Strategy | Notes |
|------------|----------------------|-------|
| Company Name | `document.querySelector('main h1, h1')` | First h1 on page |
| Description | `document.querySelector('main > p, main p:first-of-type')` | First paragraph in main |
| Employees | Field label → value pattern | See extraction logic below |
| Funding Status | Field label → value pattern | Values: "Fundraising", "Bootstrapped", etc. |
| Established | Field label → value pattern | Format: "March 2022" or "January 2015" |
| Total Funding | Field label → value pattern | Format: "$1m", "$5.2m" |
| ARR | Field label → value pattern | Format: "$500k" (often empty) |
| Categories/Tags | Badge/pill elements | Multiple tags like "B2B", "Healthcare", "SaaS" |
| Website URL | LinkedIn icon sibling or external link | May not always be present |
| LinkedIn URL | LinkedIn icon href | Company LinkedIn page |

---

## 3. DATA EXTRACTION IMPLEMENTATION

### 3.1 Content Script Structure

**File:** `src/content/dealigence-extractor.ts`
```typescript
/**
 * Content script for extracting company data from Dealigence pages
 * Runs on https://dealigence.vc/company/*
 */

import type { Deal, Contact } from '../lib/types';

export interface DealigenceCompanyData {
  companyName: string;
  description: string;
  website?: string;
  linkedinUrl?: string;
  employees?: string;
  fundingStatus?: string;
  established?: string;
  totalFunding?: string;
  arr?: string;
  categories: string[];
  founders: DealigenceFounder[];
  stakeholders: DealigenceStakeholder[];
}

interface DealigenceFounder {
  name: string;
  linkedinUrl?: string;
}

interface DealigenceStakeholder {
  name: string;
  role: string;
}

/**
 * Main extraction function
 */
export function extractCompanyData(): DealigenceCompanyData | null {
  // Check if we're on a company page
  if (!isDealigenceCompanyPage()) {
    return null;
  }

  const data: DealigenceCompanyData = {
    companyName: extractCompanyName(),
    description: extractDescription(),
    categories: extractCategories(),
    founders: extractFounders(),
    stakeholders: extractStakeholders(),
  };

  // Extract structured fields
  const fields = extractStructuredFields();
  Object.assign(data, fields);

  // Extract URLs
  data.website = extractWebsiteUrl();
  data.linkedinUrl = extractLinkedInUrl();

  return data;
}

/**
 * Check if current page is a Dealigence company page
 */
function isDealigenceCompanyPage(): boolean {
  return /^https:\\/\\/dealigence\\.vc\\/company\\/[^\\/]+$/.test(window.location.href);
}

/**
 * Extract company name from h1
 */
function extractCompanyName(): string {
  const h1 = document.querySelector('main h1, h1');
  return h1?.textContent?.trim() || '';
}

/**
 * Extract company description
 */
function extractDescription(): string {
  // Get the first paragraph after the h1 in main
  const main = document.querySelector('main');
  if (!main) return '';
  
  const p = main.querySelector('p');
  return p?.textContent?.trim() || '';
}

/**
 * Extract structured fields using label-value pair pattern
 */
function extractStructuredFields(): {
  employees?: string;
  fundingStatus?: string;
  established?: string;
  totalFunding?: string;
  arr?: string;
} {
  const fields: Record = {};
  const fieldNames = ['Employees', 'Funding Status', 'Established', 'Total Funding', 'ARR'];
  
  fieldNames.forEach(fieldName => {
    // Find all elements in main
    const allElements = document.querySelectorAll('main *');
    
    for (const el of Array.from(allElements)) {
      // Check if element contains exactly the field name (no children)
      if (el.textContent?.trim() === fieldName && el.childElementCount === 0) {
        // Found label element, look for value
        let value = null;
        
        // Strategy 1: Next sibling element
        const nextSibling = el.nextElementSibling;
        if (nextSibling && nextSibling.textContent && nextSibling.textContent.trim().length < 50) {
          value = nextSibling.textContent.trim();
        }
        
        // Strategy 2: Parent's next sibling
        if (!value && el.parentElement) {
          const parentNext = el.parentElement.nextElementSibling;
          if (parentNext && parentNext.textContent) {
            const text = parentNext.textContent.trim();
            if (text.length < 50) {
              value = text;
            }
          }
        }
        
        if (value) {
          const key = fieldName.toLowerCase().replace(/ /g, '');
          fields[key] = value;
          break;
        }
      }
    }
  });
  
  return fields;
}

/**
 * Extract category tags
 */
function extractCategories(): string[] {
  const categories = new Set();
  
  // Look for badge/pill/tag-like elements in main
  const selectors = [
    'main [class*="badge"]',
    'main [class*="pill"]', 
    'main [class*="tag"]',
    'main [class*="category"]',
  ];
  
  selectors.forEach(selector => {
    const elements = document.querySelectorAll(selector);
    elements.forEach(el => {
      const text = el.textContent?.trim();
      // Filter out noise
      if (text && text.length > 1 && text.length < 30) {
        // Exclude field labels and percentages
        if (!text.includes('Employees') && 
            !text.includes('Funding') && 
            !text.includes('Established') &&
            !text.match(/^\\d+\\.?\\d*%$/)) {
          categories.add(text);
        }
      }
    });
  });
  
  return Array.from(categories).slice(0, 10); // Limit to first 10
}

/**
 * Extract founder information
 */
function extractFounders(): DealigenceFounder[] {
  const founders: DealigenceFounder[] = [];
  
  // Find the Founders section
  const main = document.querySelector('main');
  if (!main) return founders;
  
  const founderHeading = Array.from(main.querySelectorAll('h2, h3')).find(
    h => h.textContent?.trim() === 'Founders'
  );
  
  if (!founderHeading) return founders;
  
  // Look for founder profiles in the section
  let current = founderHeading.nextElementSibling;
  while (current && current.tagName !== 'H2' && current.tagName !== 'H3') {
    // Look for LinkedIn links or profile containers
    const links = current.querySelectorAll('a[href*="linkedin.com"]');
    links.forEach(link => {
      const name = extractNameFromLinkedInUrl(link.getAttribute('href') || '');
      if (name) {
        founders.push({
          name,
          linkedinUrl: link.getAttribute('href') || undefined,
        });
      }
    });
    
    current = current.nextElementSibling;
  }
  
  return founders;
}

/**
 * Extract stakeholder/advisor information
 */
function extractStakeholders(): DealigenceStakeholder[] {
  const stakeholders: DealigenceStakeholder[] = [];
  
  const main = document.querySelector('main');
  if (!main) return stakeholders;
  
  // Find Stakeholders & Advisors section
  const heading = Array.from(main.querySelectorAll('h2, h3')).find(
    h => h.textContent?.includes('Stakeholders') || h.textContent?.includes('Advisors')
  );
  
  if (!heading) return stakeholders;
  
  // Extract name and role patterns
  // Common patterns: "Name" followed by "Role Title"
  const textContent = main.textContent || '';
  const stakeholderPattern = /([A-Z][a-z]+ [A-Z][a-z]+)\\s+(Advisory Board Member|Advisor|Board Member|Strategic|Angel|Investor)/g;
  
  let match;
  while ((match = stakeholderPattern.exec(textContent)) !== null) {
    stakeholders.push({
      name: match[1],
      role: match[2],
    });
  }
  
  return stakeholders.slice(0, 10); // Limit to first 10
}

/**
 * Extract website URL
 */
function extractWebsiteUrl(): string | undefined {
  const main = document.querySelector('main');
  if (!main) return undefined;
  
  // Look for external links (not dealigence.vc, not linkedin)
  const links = main.querySelectorAll('a[href]');
  for (const link of Array.from(links)) {
    const href = link.getAttribute('href') || '';
    if (href.startsWith('http') && 
        !href.includes('dealigence.vc') && 
        !href.includes('linkedin.com') &&
        !href.includes('twitter.com') &&
        !href.includes('facebook.com')) {
      return href;
    }
  }
  
  return undefined;
}

/**
 * Extract LinkedIn company URL
 */
function extractLinkedInUrl(): string | undefined {
  const main = document.querySelector('main');
  if (!main) return undefined;
  
  // Look for LinkedIn company links (not personal profiles in founders section)
  const links = main.querySelectorAll('a[href*="linkedin.com/company"]');
  if (links.length > 0) {
    return links[0].getAttribute('href') || undefined;
  }
  
  return undefined;
}

/**
 * Helper: Extract name from LinkedIn URL
 */
function extractNameFromLinkedInUrl(url: string): string {
  const match = url.match(/linkedin\\.com\\/in\\/([^\\/\\?]+)/);
  if (match) {
    return match[1].replace(/-/g, ' ').replace(/\\b\\w/g, l => l.toUpperCase());
  }
  return '';
}

/**
 * Map Dealigence data to CRM Deal format
 */
export function mapToCrmDeal(dealigenceData: DealigenceCompanyData): Partial {
  const deal: Partial = {
    CompanyName: dealigenceData.companyName,
  };
  
  if (dealigenceData.description) {
    deal.Description = dealigenceData.description;
  }
  
  if (dealigenceData.website) {
    deal.Website = dealigenceData.website;
  }
  
  // Map categories to Sector (take first relevant one)
  const sectorKeywords = ['Healthcare', 'Fintech', 'SaaS', 'AI', 'Manufacturing'];
  const sector = dealigenceData.categories.find(cat => 
    sectorKeywords.some(keyword => cat.includes(keyword))
  );
  if (sector) {
    deal.Sector = sector;
  }
  
  // Map funding status to Stage
  if (dealigenceData.fundingStatus) {
    deal.Stage = mapFundingStatusToStage(dealigenceData.fundingStatus);
  }
  
  // Store raw Dealigence data in notes field
  deal.SourceNotes = `Imported from Dealigence\\n\\nFunding Status: ${dealigenceData.fundingStatus || 'N/A'}\\nTotal Funding: ${dealigenceData.totalFunding || 'N/A'}\\nEstablished: ${dealigenceData.established || 'N/A'}\\nEmployees: ${dealigenceData.employees || 'N/A'}\\nCategories: ${dealigenceData.categories.join(', ')}`;
  
  return deal;
}

/**
 * Map funding status to CRM Stage
 */
function mapFundingStatusToStage(fundingStatus: string): string {
  const statusLower = fundingStatus.toLowerCase();
  
  if (statusLower.includes('fundraising')) return 'Fundraising';
  if (statusLower.includes('seed')) return 'Seed';
  if (statusLower.includes('series a')) return 'Series A';
  if (statusLower.includes('series b')) return 'Series B';
  if (statusLower.includes('bootstrap')) return 'Bootstrapped';
  
  return 'Unknown';
}

/**
 * Map first founder to CRM Contact format
 */
export function mapToCrmContact(
  dealigenceData: DealigenceCompanyData,
  companyId?: string
): Partial | null {
  if (dealigenceData.founders.length === 0) {
    return null;
  }
  
  const founder = dealigenceData.founders[0];
  
  const contact: Partial = {
    Name: founder.name,
    ContactTypeID: 'FDR', // Founder type
  };
  
  if (companyId) {
    contact.CompanyID = companyId;
  }
  
  // LinkedIn can be stored in a custom field or notes
  if (founder.linkedinUrl) {
    contact.LinkedIn = founder.linkedinUrl;
  }
  
  return contact;
}
```

### 3.2 Content Script Registration

**File:** `manifest.json` (update)
```json
{
  "content_scripts": [
    {
      "matches": ["https://dealigence.vc/company/*"],
      "js": ["src/content/dealigence-extractor.js"],
      "run_at": "document_idle"
    }
  ],
  "permissions": [
    "activeTab",
    "storage"
  ],
  "host_permissions": [
    "https://dealigence.vc/*",
    "https://run.mydealflow.com/*"
  ]
}
```

---

## 4. UI INTEGRATION

### 4.1 Popup Enhancement

**File:** `src/popup/App.tsx` (modifications)

Add new state to detect if user is on a Dealigence page:
```typescript
const [isDealigencePage, setIsDealigencePage] = useState(false);
const [dealigenceData, setDealigenceData] = useState(null);

useEffect(() => {
  // Check if current tab is Dealigence
  chrome.tabs.query({ active: true, currentWindow: true }, async (tabs) => {
    const tab = tabs[0];
    if (tab.url?.match(/^https:\\/\\/dealigence\\.vc\\/company\\/[^\\/]+$/)) {
      setIsDealigencePage(true);
      
      // Request data extraction from content script
      const data = await chrome.tabs.sendMessage(tab.id!, { type: 'EXTRACT_COMPANY_DATA' });
      setDealigenceData(data);
    }
  });
}, []);
```

Add new UI mode for quick upload:
```typescript
{isDealigencePage && dealigenceData && (
  
    Quick Upload from Dealigence
    
      {dealigenceData.companyName}
      {dealigenceData.description.substring(0, 150)}...
      
        Employees: {dealigenceData.employees || 'N/A'}
        Funding: {dealigenceData.totalFunding || 'N/A'}
      
    
    
    <button 
      onClick={() => handleQuickUpload(dealigenceData)}
      className="primary-button"
    >
      Upload to CRM
    
  
)}
```

### 4.2 Quick Upload Handler
```typescript
async function handleQuickUpload(dealigenceData: DealigenceCompanyData) {
  try {
    // 1. Map to CRM format
    const dealData = mapToCrmDeal(dealigenceData);
    
    // 2. Validate against schema
    const schema = await fetchSchema();
    const validation = validateDeal(dealData, schema);
    
    if (!validation.valid) {
      // Show validation errors
      setValidationErrors(validation.errors);
      return;
    }
    
    // 3. Check for duplicates
    const duplicateCheck = await checkDuplicate(
      dealData.CompanyName!,
      dealData.Website
    );
    
    if (duplicateCheck.isDuplicate) {
      // Show duplicate warning with option to proceed
      setDuplicateWarning(duplicateCheck);
      return;
    }
    
    // 4. Create deal
    const createdDeal = await createDeal(dealData);
    
    // 5. Optionally create founder contact
    if (dealigenceData.founders.length > 0) {
      const contactData = mapToCrmContact(dealigenceData, createdDeal.id);
      if (contactData) {
        await createContact(contactData);
      }
    }
    
    // 6. Show success
    showSuccessMessage(`${dealData.CompanyName} uploaded successfully!`);
    
  } catch (error) {
    showErrorMessage(`Upload failed: ${error.message}`);
  }
}
```

---

## 5. BACKGROUND SCRIPT MODIFICATIONS

**File:** `src/background/index.ts` (additions)

Add message handler for data extraction request:
```typescript
// Listen for messages from popup/content scripts
chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
  if (request.type === 'EXTRACT_COMPANY_DATA') {
    // Forward to content script
    if (sender.tab?.id) {
      extractFromDealigence(sender.tab.id).then(sendResponse);
      return true; // Will respond asynchronously
    }
  }
  
  // ... existing message handlers
});

async function extractFromDealigence(tabId: number): Promise {
  try {
    const [result] = await chrome.scripting.executeScript({
      target: { tabId },
      func: () => {
        // This will be injected and executed
        return (window as any).extractCompanyData?.();
      },
    });
    
    return result.result;
  } catch (error) {
    console.error('Failed to extract Dealigence data:', error);
    return null;
  }
}
```

---

## 6. TESTING STRATEGY

### 6.1 Unit Tests

**File:** `src/content/__tests__/dealigence-extractor.test.ts`
```typescript
import { extractCompanyData, mapToCrmDeal } from '../dealigence-extractor';

describe('Dealigence Extractor', () => {
  beforeEach(() => {
    // Set up DOM with sample Dealigence HTML
    document.body.innerHTML = `
      
        Test Company
        This is a test description.
        Employees7
        Funding StatusFundraising
      
    `;
  });
  
  test('extracts company name', () => {
    const data = extractCompanyData();
    expect(data?.companyName).toBe('Test Company');
  });
  
  test('extracts structured fields', () => {
    const data = extractCompanyData();
    expect(data?.employees).toBe('7');
    expect(data?.fundingStatus).toBe('Fundraising');
  });
  
  test('maps to CRM format correctly', () => {
    const dealigenceData = extractCompanyData()!;
    const crmDeal = mapToCrmDeal(dealigenceData);
    
    expect(crmDeal.CompanyName).toBe('Test Company');
    expect(crmDeal.Description).toBe('This is a test description.');
  });
});
```

### 6.2 Integration Tests

1. **Manual Testing Checklist:**
   - [ ] Extension icon appears on Dealigence company pages
   - [ ] Clicking icon shows "Quick Upload" option
   - [ ] Data extraction captures all visible fields correctly
   - [ ] Validation works with extracted data
   - [ ] Duplicate detection works
   - [ ] Upload succeeds and creates deal in CRM
   - [ ] Founder contact is created if available
   - [ ] Error handling works for edge cases

2. **Test Companies:**
   - https://dealigence.vc/company/eyecuracy
   - https://dealigence.vc/company/craniosense
   - https://dealigence.vc/company/brainspace-7zre8

---

## 7. DEPLOYMENT CHECKLIST

- [ ] Add content script files to build process
- [ ] Update manifest.json with new permissions and content scripts
- [ ] Build extension: `npm run build`
- [ ] Test in Chrome with "Load unpacked" from `dist/` folder
- [ ] Verify all Dealigence pages load correctly with extension
- [ ] Test extraction on at least 5 different company pages
- [ ] Verify no performance impact on other pages
- [ ] Update README with new Dealigence functionality
- [ ] Create user guide for Quick Upload feature

---


---

## 8. RISK MITIGATION

| Risk | Impact | Mitigation |
|------|--------|------------|
| Dealigence DOM changes | High | Use flexible selectors, implement fallback strategies |
| Missing data fields | Medium | Implement optional field handling, show warnings |
| Rate limiting | Low | Use existing CRM session, no additional API calls to Dealigence |
| Data validation failures | Medium | Show clear error messages, allow manual correction |
| Duplicate detection false positives | Low | Allow user to override duplicate warnings |

---

## 9. SUCCESS METRICS

- **Time saved:** Reduce company entry time from 5 minutes to < 30 seconds
- **Accuracy:** > 95% field mapping accuracy
- **Adoption:** Track usage via analytics (companies uploaded per day)
- **Error rate:** < 5% failed uploads
